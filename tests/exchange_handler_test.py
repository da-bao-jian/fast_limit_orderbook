from ..exchange_handlers.exchange_loop import ExchangeLoops
from ..exchange_handlers.exchanges.coinbase import Coinbase
from ..exchange_handlers.exchanges.ftx import FTX
from ..exchange_handlers.exchanges.bybit import Bybit
from ..exchange_handlers.defines import L2_BOOK, BOOK_DELTA
from ..exchange_handlers.symbols_parser import Symbols
import pytest

# COINBASE_TOKEN_PAIRS = {'COINBASE': {'normalized': {'DASH-BTC': 'DASH-BTC', 'USDC-GBP': 'USDC-GBP', 'ANKR-USD': 'ANKR-USD', 'GRT-BTC': 'GRT-BTC', 'BNT-GBP': 'BNT-GBP', 'BTC-USD': 'BTC-USD', 'NKN-BTC': 'NKN-BTC', 'WBTC-BTC': 'WBTC-BTC', 'AAVE-EUR': 'AAVE-EUR', 'ETH-DAI': 'ETH-DAI', 'MANA-ETH': 'MANA-ETH', 'ALGO-USD': 'ALGO-USD', 'UNI-BTC': 'UNI-BTC', 'BTC-USDT': 'BTC-USDT', 'ENJ-BTC': 'ENJ-BTC', 'RLC-BTC': 'RLC-BTC', 'BNT-BTC': 'BNT-BTC', 'MKR-USD': 'MKR-USD', 'BCH-GBP': 'BCH-GBP', 'ALGO-GBP': 'ALGO-GBP', 'ICP-BTC': 'ICP-BTC', 'MANA-BTC': 'MANA-BTC', 'GRT-EUR': 'GRT-EUR', 'SUSHI-EUR': 'SUSHI-EUR', 'ETC-EUR': 'ETC-EUR', 'OXT-USD': 'OXT-USD', 'EOS-USD': 'EOS-USD', 'BAT-USDC': 'BAT-USDC', 'MANA-USDC': 'MANA-USDC', 'OMG-BTC': 'OMG-BTC', 'NU-EUR': 'NU-EUR', 'LOOM-USDC': 'LOOM-USDC', 'ICP-GBP': 'ICP-GBP', 'BAT-USD': 'BAT-USD', 'USDT-EUR': 'USDT-EUR', 'AAVE-BTC': 'AAVE-BTC', 'CRV-BTC': 'CRV-BTC', 'NMR-USD': 'NMR-USD', 'DAI-USDC': 'DAI-USDC', 'ADA-ETH': 'ADA-ETH', 'UMA-BTC': 'UMA-BTC', 'BNT-USD': 'BNT-USD', 'KNC-USD': 'KNC-USD', 'MIR-EUR': 'MIR-EUR', 'SUSHI-GBP': 'SUSHI-GBP', 'AAVE-GBP': 'AAVE-GBP', 'GRT-USD': 'GRT-USD', 'MANA-EUR': 'MANA-EUR', 'FORTH-EUR': 'FORTH-EUR', 'XLM-USD': 'XLM-USD', 'ETC-GBP': 'ETC-GBP', 'STORJ-USD': 'STORJ-USD', 'RLC-USD': 'RLC-USD', 'ATOM-BTC': 'ATOM-BTC', 'BAL-USD': 'BAL-USD', 'XTZ-BTC': 'XTZ-BTC', 'CGLD-USD': 'CGLD-USD', 'SNX-GBP': 'SNX-GBP', 'OMG-GBP': 'OMG-GBP', 'SNX-BTC': 'SNX-BTC', 'CTSI-BTC': 'CTSI-BTC', 'MATIC-EUR': 'MATIC-EUR', 'BAND-USD': 'BAND-USD', 'ETH-BTC': 'ETH-BTC', 'REN-USD': 'REN-USD', 'SKL-EUR': 'SKL-EUR', 'ADA-BTC': 'ADA-BTC', 'REP-USD': 'REP-USD', 'ANKR-BTC': 'ANKR-BTC', 'REN-BTC': 'REN-BTC', 'ANKR-GBP': 'ANKR-GBP', 'ZRX-USD': 'ZRX-USD', 'ZEC-BTC': 'ZEC-BTC', 'BAT-EUR': 'BAT-EUR', 'WBTC-USD': 'WBTC-USD', 'ETH-GBP': 'ETH-GBP', 'USDC-EUR': 'USDC-EUR', 'SOL-GBP': 'SOL-GBP', 'CGLD-EUR': 'CGLD-EUR', 'SKL-BTC': 'SKL-BTC', 'FIL-USD': 'FIL-USD', 'TRB-USD': 'TRB-USD', 'MATIC-BTC': 'MATIC-BTC', 'REP-BTC': 'REP-BTC', 'LTC-EUR': 'LTC-EUR', 'ICP-EUR': 'ICP-EUR', 'CRV-GBP': 'CRV-GBP', 'MANA-USD': 'MANA-USD', 'LINK-GBP': 'LINK-GBP', 'ZRX-EUR': 'ZRX-EUR', 'YFI-USD': 'YFI-USD', '1INCH-GBP': '1INCH-GBP', 'NKN-USD': 'NKN-USD', 'SKL-GBP': 'SKL-GBP', 'SKL-USD': 'SKL-USD', 'ALGO-BTC': 'ALGO-BTC', 'MATIC-GBP': 'MATIC-GBP', 'UMA-GBP': 'UMA-GBP', 'XTZ-USD': 'XTZ-USD', 'ADA-GBP': 'ADA-GBP', 'BTC-EUR': 'BTC-EUR', 'LTC-GBP': 'LTC-GBP', 'LINK-USD': 'LINK-USD', 'SNX-USD': 'SNX-USD', 'EOS-BTC': 'EOS-BTC', 'YFI-BTC': 'YFI-BTC', 'BAT-ETH': 'BAT-ETH', 'FIL-EUR': 'FIL-EUR', 'BAND-EUR': 'BAND-EUR', 'FORTH-USD': 'FORTH-USD', 'GRT-GBP': 'GRT-GBP', 'MIR-USD': 'MIR-USD', 'LINK-ETH': 'LINK-ETH', 'LTC-USD': 'LTC-USD', 'UNI-USD': 'UNI-USD', 'SUSHI-USD': 'SUSHI-USD', 'CTSI-USD': 'CTSI-USD', 'SOL-USD': 'SOL-USD', 'UMA-EUR': 'UMA-EUR', 'BAL-BTC': 'BAL-BTC', 'SOL-BTC': 'SOL-BTC', 'AAVE-USD': 'AAVE-USD', 'ICP-USDT': 'ICP-USDT', 'BTC-GBP': 'BTC-GBP', 'STORJ-BTC': 'STORJ-BTC', '1INCH-EUR': '1INCH-EUR', '1INCH-USD': '1INCH-USD', 'MIR-GBP': 'MIR-GBP', 'BAND-BTC': 'BAND-BTC', 'CRV-USD': 'CRV-USD', 'NU-BTC': 'NU-BTC', 'BCH-BTC': 'BCH-BTC', 'USDT-USD': 'USDT-USD', 'ETH-USD': 'ETH-USD', 'MKR-BTC': 'MKR-BTC', 'ENJ-USD': 'ENJ-USD', 'KNC-BTC': 'KNC-BTC', 'SUSHI-BTC': 'SUSHI-BTC', 'FIL-BTC': 'FIL-BTC', 'ZEC-USDC': 'ZEC-USDC', 'MATIC-USD': 'MATIC-USD', 'TRB-BTC': 'TRB-BTC', 'LRC-BTC': 'LRC-BTC', 'ADA-EUR': 'ADA-EUR', 'NMR-EUR': 'NMR-EUR', '1INCH-BTC': '1INCH-BTC', 'GNT-USDC': 'GNT-USDC', 'ZEC-USD': 'ZEC-USD', 'ALGO-EUR': 'ALGO-EUR', 'OGN-BTC': 'OGN-BTC', 'USDT-USDC': 'USDT-USDC', 'NMR-BTC': 'NMR-BTC', 'CGLD-GBP': 'CGLD-GBP', 'ETH-EUR': 'ETH-EUR', 'BTC-USDC': 'BTC-USDC', 'BCH-EUR': 'BCH-EUR', 'BNT-EUR': 'BNT-EUR', 'SOL-EUR': 'SOL-EUR', 'XLM-BTC': 'XLM-BTC', 'CRV-EUR': 'CRV-EUR', 'SOL-USDT': 'SOL-USDT', 'ICP-USD': 'ICP-USD', 'XTZ-GBP': 'XTZ-GBP', 'EOS-EUR': 'EOS-EUR', 'NU-GBP': 'NU-GBP', 'FORTH-GBP': 'FORTH-GBP', 'DAI-USD': 'DAI-USD', 'CVC-USDC': 'CVC-USDC', 'LINK-EUR': 'LINK-EUR', 'ETH-USDC': 'ETH-USDC', 'OMG-EUR': 'OMG-EUR', 'ANKR-EUR': 'ANKR-EUR', 'ETC-USD': 'ETC-USD', 'DASH-USD': 'DASH-USD', 'XLM-EUR': 'XLM-EUR', 'LRC-USD': 'LRC-USD', 'COMP-BTC': 'COMP-BTC', 'SUSHI-ETH': 'SUSHI-ETH', 'ZRX-BTC': 'ZRX-BTC', 'OMG-USD': 'OMG-USD', 'ETH-USDT': 'ETH-USDT', 'XTZ-EUR': 'XTZ-EUR', 'DNT-USDC': 'DNT-USDC', 'FORTH-BTC': 'FORTH-BTC', 'LTC-BTC': 'LTC-BTC', 'FIL-GBP': 'FIL-GBP', 'ADA-USD': 'ADA-USD', 'USDT-GBP': 'USDT-GBP', 'BAT-BTC': 'BAT-BTC', 'ADA-USDC': 'ADA-USDC', 'ATOM-USD': 'ATOM-USD', 'NU-USD': 'NU-USD', 'COMP-USD': 'COMP-USD', 'BCH-USD': 'BCH-USD', 'UMA-USD': 'UMA-USD', 'LINK-BTC': 'LINK-BTC', 'NMR-GBP': 'NMR-GBP', 'SNX-EUR': 'SNX-EUR', 'BAND-GBP': 'BAND-GBP', 'OGN-USD': 'OGN-USD', 'MIR-BTC': 'MIR-BTC', 'CGLD-BTC': 'CGLD-BTC', 'ETC-BTC': 'ETC-BTC'}, 'info': defaultdict(<class 'dict'>, {'tick_size': {'DASH-BTC': '0.00000001', 'USDC-GBP': '0.001', 'ANKR-USD': '0.00001', 'GRT-BTC': '0.00000001', 'BNT-GBP': '0.0001', 'BTC-USD': '0.01', 'NKN-BTC': '0.0000001', 'WBTC-BTC': '0.0001', 'AAVE-EUR': '0.001', 'ETH-DAI': '0.01', 'MANA-ETH': '0.000001', 'ALGO-USD': '0.0001', 'UNI-BTC': '0.00000001', 'BTC-USDT': '0.01', 'ENJ-BTC': '0.0000001', 'RLC-BTC': '0.0000001', 'BNT-BTC': '0.00000001', 'MKR-USD': '0.0001', 'BCH-GBP': '0.01', 'ALGO-GBP': '0.0001', 'ICP-BTC': '0.0000001', 'MANA-BTC': '0.0000001', 'GRT-EUR': '0.0001', 'SUSHI-EUR': '0.001', 'ETC-EUR': '0.001', 'OXT-USD': '0.0001', 'EOS-USD': '0.001', 'BAT-USDC': '0.000001', 'MANA-USDC': '0.000001', 'OMG-BTC': '0.00000001', 'NU-EUR': '0.0001', 'LOOM-USDC': '0.000001', 'ICP-GBP': '0.001', 'BAT-USD': '0.001', 'USDT-EUR': '0.0001', 'AAVE-BTC': '0.00000001', 'CRV-BTC': '0.0000001', 'NMR-USD': '0.0001', 'DAI-USDC': '0.000001', 'ADA-ETH': '0.000001', 'UMA-BTC': '0.00000001', 'BNT-USD': '0.0001', 'KNC-USD': '0.0001', 'MIR-EUR': '0.001', 'SUSHI-GBP': '0.001', 'AAVE-GBP': '0.001', 'GRT-USD': '0.0001', 'MANA-EUR': '0.001', 'FORTH-EUR': '0.001', 'XLM-USD': '0.000001', 'ETC-GBP': '0.001', 'STORJ-USD': '0.0001', 'RLC-USD': '0.001', 'ATOM-BTC': '0.000001', 'BAL-USD': '0.00001', 'XTZ-BTC': '0.00000001', 'CGLD-USD': '0.0001', 'SNX-GBP': '0.0001', 'OMG-GBP': '0.0001', 'SNX-BTC': '0.00000001', 'CTSI-BTC': '0.0000001', 'MATIC-EUR': '0.0001', 'BAND-USD': '0.0001', 'ETH-BTC': '0.00001', 'REN-USD': '0.0001', 'SKL-EUR': '0.0001', 'ADA-BTC': '0.00000001', 'REP-USD': '0.01', 'ANKR-BTC': '0.00000001', 'REN-BTC': '0.00000001', 'ANKR-GBP': '0.00001', 'ZRX-USD': '0.000001', 'ZEC-BTC': '0.000001', 'BAT-EUR': '0.001', 'WBTC-USD': '0.01', 'ETH-GBP': '0.01', 'USDC-EUR': '0.001', 'SOL-GBP': '0.001', 'CGLD-EUR': '0.0001', 'SKL-BTC': '0.00000001', 'FIL-USD': '0.0001', 'TRB-USD': '0.001', 'MATIC-BTC': '0.00000001', 'REP-BTC': '0.000001', 'LTC-EUR': '0.01', 'ICP-EUR': '0.001', 'CRV-GBP': '0.0001', 'MANA-USD': '0.001', 'LINK-GBP': '0.00001', 'ZRX-EUR': '0.000001', 'YFI-USD': '0.01', '1INCH-GBP': '0.001', 'NKN-USD': '0.0001', 'SKL-GBP': '0.0001', 'SKL-USD': '0.0001', 'ALGO-BTC': '0.00000001', 'MATIC-GBP': '0.0001', 'UMA-GBP': '0.001', 'XTZ-USD': '0.0001', 'ADA-GBP': '0.0001', 'BTC-EUR': '0.01', 'LTC-GBP': '0.01', 'LINK-USD': '0.00001', 'SNX-USD': '0.0001', 'EOS-BTC': '0.000001', 'YFI-BTC': '0.00001', 'BAT-ETH': '0.00000001', 'FIL-EUR': '0.0001', 'BAND-EUR': '0.0001', 'FORTH-USD': '0.001', 'GRT-GBP': '0.0001', 'MIR-USD': '0.001', 'LINK-ETH': '0.00000001', 'LTC-USD': '0.01', 'UNI-USD': '0.0001', 'SUSHI-USD': '0.001', 'CTSI-USD': '0.0001', 'SOL-USD': '0.001', 'UMA-EUR': '0.001', 'BAL-BTC': '0.00000001', 'SOL-BTC': '0.0000001', 'AAVE-USD': '0.001', 'ICP-USDT': '0.001', 'BTC-GBP': '0.01', 'STORJ-BTC': '0.00000001', '1INCH-EUR': '0.001', '1INCH-USD': '0.001', 'MIR-GBP': '0.001', 'BAND-BTC': '0.00000001', 'CRV-USD': '0.0001', 'NU-BTC': '0.00000001', 'BCH-BTC': '0.00001', 'USDT-USD': '0.0001', 'ETH-USD': '0.01', 'MKR-BTC': '0.00001', 'ENJ-USD': '0.001', 'KNC-BTC': '0.00000001', 'SUSHI-BTC': '0.00000001', 'FIL-BTC': '0.00000001', 'ZEC-USDC': '0.01', 'MATIC-USD': '0.0001', 'TRB-BTC': '0.0000001', 'LRC-BTC': '0.00000001', 'ADA-EUR': '0.0001', 'NMR-EUR': '0.0001', '1INCH-BTC': '0.0000001', 'GNT-USDC': '0.000001', 'ZEC-USD': '0.01', 'ALGO-EUR': '0.0001', 'OGN-BTC': '0.0000001', 'USDT-USDC': '0.0001', 'NMR-BTC': '0.00000001', 'CGLD-GBP': '0.0001', 'ETH-EUR': '0.01', 'BTC-USDC': '0.01', 'BCH-EUR': '0.01', 'BNT-EUR': '0.0001', 'SOL-EUR': '0.001', 'XLM-BTC': '0.00000001', 'CRV-EUR': '0.0001', 'SOL-USDT': '0.001', 'ICP-USD': '0.001', 'XTZ-GBP': '0.00001', 'EOS-EUR': '0.001', 'NU-GBP': '0.0001', 'FORTH-GBP': '0.001', 'DAI-USD': '0.000001', 'CVC-USDC': '0.000001', 'LINK-EUR': '0.00001', 'ETH-USDC': '0.01', 'OMG-EUR': '0.0001', 'ANKR-EUR': '0.00001', 'ETC-USD': '0.001', 'DASH-USD': '0.001', 'XLM-EUR': '0.000001', 'LRC-USD': '0.0001', 'COMP-BTC': '0.000001', 'SUSHI-ETH': '0.000001', 'ZRX-BTC': '0.00000001', 'OMG-USD': '0.0001', 'ETH-USDT': '0.01', 'XTZ-EUR': '0.00001', 'DNT-USDC': '0.000001', 'FORTH-BTC': '0.0000001', 'LTC-BTC': '0.000001', 'FIL-GBP': '0.0001', 'ADA-USD': '0.0001', 'USDT-GBP': '0.0001', 'BAT-BTC': '0.0000001', 'ADA-USDC': '0.001', 'ATOM-USD': '0.001', 'NU-USD': '0.0001', 'COMP-USD': '0.01', 'BCH-USD': '0.01', 'UMA-USD': '0.001', 'LINK-BTC': '0.00000001', 'NMR-GBP': '0.0001', 'SNX-EUR': '0.0001', 'BAND-GBP': '0.0001', 'OGN-USD': '0.001', 'MIR-BTC': '0.0000001', 'CGLD-BTC': '0.00000001', 'ETC-BTC': '0.000001'}})}

@pytest.fixture(scope="module")
def coinbase_instance():
    async def book(feed, symbol, book, timestamp, receipt_timestamp):
        print(f'Timestamp: {timestamp} Receipt Timestamp: {receipt_timestamp} Feed: {feed} Pair: {symbol} Snapshot: {book}')
    async def delta(feed, symbol, delta, timestamp, receipt_timestamp):
        print(f'Timestamp: {timestamp} Receipt Timestamp: {receipt_timestamp} Feed: {feed} Pair: {symbol} Delta: {delta}')

    return Coinbase(symbols=['BTC-USD'], channels=[L2_BOOK], callbacks={BOOK_DELTA: delta, L2_BOOK: book})

@pytest.fixture
def exchange_loop_instance():
    f = ExchangeLoops()
    return f

def test_coinbase_parse_symbol_data(coinbase_instance):
    symbols = Symbols
    assert symbols.populated('COINBASE') == True
    assert symbols.data['COINBASE']['normalized'] != None


def test_add_event_loop(coinbase_instance, exchange_loop_instance):
    exchange_loop_instance.add_loop(coinbase_instance) 
    assert len(exchange_loop_instance.loops) != 0 
    assert isinstance(exchange_loop_instance.loops[0], Coinbase)

def test_no_feed_in_event_loop_error(exchange_loop_instance):
    with pytest.raises(ValueError):
        exchange_loop_instance.start_loops()

    
